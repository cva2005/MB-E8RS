**Описание работы ВПО устройства EspRecord**

`	`**Описание бизнес-логики ВПО устройства.**

`	`Встраиваемое программное обеспечение устройства основано на базе фрейморка ESP ADF. Оно включают в себя набор функций, объединенные в библиотеку «Audio Recorder».

`	`При обнаружении аккустической активности на входе микрофона включается механизм записи данных микрофона, кодирование потока данных и запись потока в устройство хранения с последующей передачей сохраненных файлов на внешний файловый сервер. Если внешний файловый сервер доступен во время обнаружения активности, то данные передаются потоком непосредственно на сервер. Передача сохраненных данных на внешний сервер в режиме ожидания осущетвляется или по обнаружению маячка (iBeacon) с заданным идетификатором или по времени (периодически проверяется доступность сервера). В состоянии ожидания устройство находиться в режиме пониженного энергопотребления (ULP mode). В этом режиме ULP сопроцессор производит чтение данных микрофона по шине I2S. При обнаружении данных выше порогового уровня производится выход из режима ULP и включается основная логика записи аудиоданных. При первом включении устройства производится синхронизация внутренних часов устройства с внешним сервером времени. В дальнейшем проверяется только корректность текущего времени. Перед началом всех операций производится контроль напряжения питания устройства. При снижении питания ниже критичекского уровня устройство принудительно переводится в режим ULP.

**Структура ПО устройства, назначение модулей (блоков).**

- *Основной модуль работы с аудио данными - аудио-ковейер (pipeline). [mic]-->i2s\_stream-->audio\_encoder-->stream\_writer-->[FTP server]. Расположение \components\pipeline. Модуль включает в себя следующие элементы:*

*- i2s\_stream элемент чтения аудио данных по интерфейсу I2S. элемент* имеет гибкую структуру настроек режимов работы, в зависимости от типа I2S устройства на входе модуля. В этом элементе конвейера используется дополнительный буфер дублирующий аудиопоток по которому определяется снижение аккустической активности и завершение работы аудиоконвейера;

*- audio\_encoder элемент энкодерана основе библиотеки esp\_audio\_codec ESP ADF (компонент encoder).* Библиотека не имеет открытого исходного кода. Модуль работает с кодеком AAC;

` `*- stream\_writer элемент записи аудиопотока.* Запись осуществляется непосредственно на внутреннее устройство хранения в виде файлов .AAC. Опционально предполагается передача аудиопотока непосредственно на FTP сервер (при его доступности). На сервере файлы сохраняются в папке с именем, уникальным для каждого устройства (эквивалентным численному значению MAC адреса SoC). Имена файлов генерируются автоматически из времени в формате UTC (к-во мс от 00:00 01.01.1970).

`	`Настройки параметров модуля аудио данных осуществляется в меню конфигурации проекта "I2S STD Project Configuration".

- *Модуль FTP клиент.* *Расположение \components\ftpClient. Модуль* используется для сохранения файлов, с внутреннего диска устройства на внешнем FTP сервере. Настройка параметров сервера осуществляется в меню конфигурации проекта "FTP Server Setting".
- *Модуль SNTP клиент.* *Расположение \components\sntp\_time. Модуль* используется для сохранения файлов, с внутреннего диска устройства на внешнем FTP сервере. Настройка параметров модуля осуществляется в меню конфигурации проекта "SNTP TIME Configuration"("ibeacon Scan Time", "ibeacon major constant", "ibeacon minor constant").
- *Модуль приемника BLE маячка (компонент ibeacon), основан на базовом примере (ESP-IDF iBeacon demo).* *Расположение \components\ibeacon.* Приемник принимает сигнал от ibeacon маячка и меняет режим работы устройства по заданному алгоритму. Настройка параметров модуля *iBeacon* осуществляется в меню конфигурации проекта "Unload Files configuration"
- *Модуль обновления встроенного программного обеспечения (Расположение \components\https\_ota), основан на базовом примере (ESP-IDF system\ota\advanced\_https\_ota).* Модуль производит обновление ВПО с*огласно технологии OTA (Over-the-Air):*

\- облачный сервер передает информацию OTA на устройство;

\- устройство проверяет подлинность облачного сервера и 	 загружает  	прошивку с доверенного облачного сервера;

\- устройство решает, выполнять ли OTA в соответствии с 	информацией о версии прошивки. Если оно решает выполнить 	OTA, прошивка запрашивается и записывается во флеш-память. 	После успешного завершения проверки система переходит к 	запуску на новой прошивке.

- *Модуль хранения аудио файлов  (Расположение \components\file\_server, файл mount.c) основан на компонентах (ESP-IDF fatfs, ESP-IDF spiffs, joltwallet\_\_littlefs).* Компоненты представляют из себя реализации файловой системы FAT, предназначенные для хранения во внутренней  FLASH памяти. Выбор реализации файловой системы осуществляется через макроопределение #define FILE\_SYSTEM.
- *Модуль потоковой записи аудио данных на FTP сервер  (расположение \components\ftp\_stream).* Модуль является экземпляром класса audio element фреймворка ESP-ADF. Модуль использует функции компонента "FTP клиент".
- *Модуль мультиплекирования потоков аудиоданных  (расположение \components\mux\_stream).* Модуль является экземпляром класса audio element фреймворка ESP-ADF. Модуль предназначен для создания дополнительного буфера аудиоданных при наличии паралельных потоков в аудиоконвейере. В последней версии проекта не применяется.
- *Модуль диагностики напряжения батареи  (расположение \components\battery), основан на базовом примере system\battery ESP-ADF.* Компоненты представляют из себя модуль однократного тестирования напряжения батареи. Настройки порогов напряжения модуля осуществляется в меню конфигурации проекта "Battery Monitor Configuration".
- *Модуль обнаружения голосовой активности (VAD)  (расположение \components\vad).* В режиме VAD основной процессор находится в редиме DEEP SLEEP. ULP сопроцессор производит чтение данных микрофона по шине I2S. Производится накопление массива аудиоданных. Размер массива определяется констанотой #define FLT\_N. Пороговое значение при определениии активности вычисляется как среднее численное значение из накомпленного массива. При обнаружении данных выше порогового уровня производится выход из режима ULP и включается основная логика записи аудиоданных. Настройки параметров модуля VAD осуществляется в меню конфигурации проекта "I2S STD Project Configuration" (VOICE\_VAD\_LEVEL - "Multipleer Voice detect Input Data", ULP\_TIME\_OUT\_SEC - "Time Out Value in Seconds").
- *Организация главного программного цикла* (*Расположение \main, файл i2s\_std\_main.c)*. При включении или перезанрузке освного процессора, управление передается функции "void app\_main(void)". В ней производится инициализация периферии контроллера, управление основной логикой устройства. Две переменные с квалификатором RTC\_DATA\_ATTR сохраняют свое значение после перезагрузки и предназначениы для управления процедурой обновления ВПО (update\_del - счетчик циклов ожидания) и управления включением записи (voice\_detect - детектор звуковой активности).

`	`Производится однократное тестирование напряжения источника питания устройства. При обнаружении напряжения питания ниже критического уровня устройство уходит в режим ожидания и пониженного энергопотребления.

`	`Производится проверка условий соединения с облачным сервером обновления ВПО устройства. Если условия выпонены, то производится подключение к серверу, проверка новых версий и обновление ПО.

`	`Производится проверка часов реального времени. Если часы не были синхронизированы ранее, то выполняестся попытка синхронизации с записью текущего времени во внуренние переменные, которые сохраняют значение при перезагрузке основного процессора.

`	`Производится монитрование внутреннего хранилища в зависимости от выбранного типа памяти и типа драйвера файловой системы. Выбор осуществляется через макроопределения в файле mount.c :

#define FILE\_SYSTEM SYS\_SPIF\_FS / LITTLE\_FS / EXT\_FLASH\_FS

`	`Производится проверка хранилища на наличие данных для выгрузки. При выполнений условий вызрузки (или по сигналу маячка или по времени) выполяется попытка содинения с сервером и выгрузка данных. При неудачной попытке выгрузки и заполнеии хранилища выше критического уровня управление передается на вход в режим пониженнго энергопотребления. Устройство будет производить попытки выгрузки данных хранилища с периодичностью, определнной константой конфигурации (ULP\_TIME\_OUT\_SEC).

`	`Производится анализ причины выхода процессора из режима ожидания. Если была детектирована звуковая активность, то управление передается на аудиоконвейер и производится штатная процедура сохранения аудиоданных на внутренний диск устройства или на внешний FTP сервер. Если причиной выхода явился интервальный таймер ожидания, то производится переход в режим пониженного энергопотребления и ожидание звуковой активности или срабатывания интервального таймера.

